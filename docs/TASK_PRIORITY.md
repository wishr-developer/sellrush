# SELL RUSH 優先度付きタスクリスト

最終更新: 2025-12-02

## 🎯 優先度の定義

- **P0**: 即座に対応が必要（セキュリティ・データ損失リスク）
- **P1**: 高優先度（UX・機能の完成度向上）
- **P2**: 中優先度（コード品質・保守性向上）
- **P3**: 低優先度（将来の拡張性・最適化）

---

## P0: セキュリティ・安定性の確保

### 1. Supabase Service Role Key のフォールバック削除
**現状**: `src/app/api/stripe/webhook/route.ts` で `SUPABASE_SERVICE_ROLE_KEY || NEXT_PUBLIC_SUPABASE_ANON_KEY` という危険なフォールバックがある

**対応**:
- Webhook では Service Role Key が必須であることを明示
- 環境変数チェックを厳格化
- フォールバックを削除

**影響**: Webhook が正しく動作しなくなる可能性があるため、Vercel環境変数の設定確認が必要

**見積もり**: 30分

---

### 2. 環境変数の一元管理とバリデーション
**現状**: 各ファイルで個別に環境変数をチェックしている

**対応**:
- `src/lib/env.ts` を作成し、環境変数を一元管理
- 起動時に必須環境変数の存在をチェック
- 型安全な環境変数アクセスを提供

**影響**: ビルド時・実行時に環境変数の不足を早期発見できる

**見積もり**: 1時間

---

## P1: UX・機能の完成度向上

### 3. Influencer/Creator ダッシュボードの改善
**現状**: `/dashboard` は実装されているが、UXの改善余地がある

**対応**:
- 売上・クリック数・コンバージョン・報酬見込みを一目で見れるKPIカードの改善
- 紹介リンク生成フローの改善（モーダル・コピーボタン・QRコード表示）
- ローディング・エラー表示の改善
- 型の厳密化（`any` の削減）

**影響**: クリエイターの体験が大幅に向上

**見積もり**: 4-6時間

---

### 4. Brand/D2C 用フローの整備
**現状**: `/brand` は実装されているが、商品登録・報酬率設定・売上ダッシュボードが不完全

**対応**:
- 商品登録フォームの完成（画像アップロード・バリデーション）
- 報酬率・バトル設定のUI改善
- 売上ダッシュボードのメトリクス追加
- エラーハンドリングの統一

**影響**: ブランド側の体験が完成する

**見積もり**: 6-8時間

---

### 5. ランキング機能の実装
**現状**: `/api/rankings` は空の配列を返すだけ

**対応**:
- Supabase データベース関数を作成（ランキング計算）
- またはマテリアライズドビューを作成
- API Route の実装
- フロントエンドでのランキング表示

**影響**: バトル機能の核心部分が動くようになる

**見積もり**: 3-4時間

---

## P2: コード品質・保守性向上

### 6. Supabase 型定義の生成と適用
**現状**: `any` 型が多用され、型安全性が低い

**対応**:
- `supabase gen types typescript` で型定義を生成
- `src/types/database.ts` に保存
- 既存コードの `any` を型定義に置き換え

**影響**: 型安全性が向上し、開発効率が上がる

**見積もり**: 2-3時間

---

### 7. Supabase クライアント生成の統一
**現状**: クライアント側で `createClient`、サーバー側で `createServerClient` を使用

**対応**:
- `src/lib/supabase.ts` を `createServerClient` ベースに統一
- クライアント・サーバー両方で使えるラッパー関数を作成
- 既存コードの置き換え

**影響**: コードの一貫性が向上

**見積もり**: 2-3時間

---

### 8. エラーハンドリングの統一
**現状**: API Route ごとにエラーハンドリングが異なる

**対応**:
- `src/lib/api-error.ts` を作成し、エラーレスポンスの標準化
- エラーログの統一フォーマット
- クライアント側でのエラー表示の統一

**影響**: デバッグが容易になり、UXが向上

**見積もり**: 2-3時間

---

### 9. Next.js 16 ベストプラクティスの確認
**現状**: `useSearchParams` は Suspense でラップ済みだが、他に問題がないか確認が必要

**対応**:
- Browser 機能で Next.js 16 ドキュメントを参照
- `use client` の付けすぎ/付けなさすぎをチェック
- Server Components を活用できる箇所を特定
- 必要に応じてリファクタリング

**影響**: パフォーマンスとコード品質が向上

**見積もり**: 2-3時間

---

## P3: 将来の拡張性・最適化

### 10. Admin ダッシュボードの最低限の整備
**現状**: Admin 画面は実装されているが、メトリクス表示が不完全

**対応**:
- 全体の売上・ユーザー数・アクティブバトル数などのメトリクスを表示
- セキュリティ的に危険な操作は TODO コメントに残し、read-only ダッシュボードを優先

**影響**: 運営側の状況把握が容易になる

**見積もり**: 3-4時間

---

### 11. DX 向上: スクリプトとCI/CD
**現状**: `typecheck` スクリプトがない、CI/CD の設定がない

**対応**:
- `package.json` に `typecheck` スクリプトを追加
- GitHub Actions または Vercel Checks で `lint` と `typecheck` を実行
- `docs/deploy-checklist.md` を作成

**影響**: デプロイ前のエラーを早期発見できる

**見積もり**: 1-2時間

---

### 12. ドキュメントの整備
**現状**: README はあるが、開発者向けドキュメントが不足

**対応**:
- `docs/ARCHITECTURE.md` - アーキテクチャの説明
- `docs/API.md` - API Routes の仕様
- `docs/DEPLOYMENT.md` - デプロイ手順
- `docs/TROUBLESHOOTING.md` - トラブルシューティング

**影響**: 新しい開発者のオンボーディングが容易になる

**見積もり**: 2-3時間

---

## 📊 推奨実装順序

### Phase 1: 基盤の安定化（1-2日）
1. P0-1: Supabase Service Role Key のフォールバック削除
2. P0-2: 環境変数の一元管理とバリデーション
3. P2-6: Supabase 型定義の生成と適用

### Phase 2: 機能の完成度向上（3-5日）
4. P1-3: Influencer/Creator ダッシュボードの改善
5. P1-4: Brand/D2C 用フローの整備
6. P1-5: ランキング機能の実装

### Phase 3: コード品質向上（2-3日）
7. P2-7: Supabase クライアント生成の統一
8. P2-8: エラーハンドリングの統一
9. P2-9: Next.js 16 ベストプラクティスの確認

### Phase 4: 運営・DX向上（2-3日）
10. P3-10: Admin ダッシュボードの最低限の整備
11. P3-11: DX 向上: スクリプトとCI/CD
12. P3-12: ドキュメントの整備

---

## 🚨 注意事項

- **破壊的変更**: P0-1 の Service Role Key フォールバック削除は、Vercel環境変数の設定確認が必要
- **外部サービス設定**: P1-5 のランキング機能実装は、Supabase データベース関数の作成が必要（SQL実行が必要）
- **段階的実装**: 一度に全てを実装せず、小さなPR単位で進めることを推奨

