# Phase 13-SCALE: 自動化設計書

最終更新: [YYYY-MM-DD]

このドキュメントは、判断結果「SCALE」に基づき、手動前提を捨てて本格運用構成に入る準備のための自動化設計書です。

---

## 📋 前提条件

- `docs/PHASE12_DECISION.md` で「SCALE」が選択されている
- 再現性が見えた
- 明確な手応えがあった

---

## 現在「人がやっている作業」の洗い出し

### Phase 11 の運用手順から抽出

#### Step A: 本番開始前チェック（Preflight）

1. **Supabase 環境確認**
   - [ ] プロジェクト確認（手動）
   - [ ] ユーザー確認（手動）
   - [ ] テーブル状態確認（手動）

2. **トーナメント準備**
   - [ ] SQL でトーナメント作成（手動）
   - [ ] 表示確認（手動）

3. **決済安全チェック**
   - [ ] Stripe 環境確認（手動）

#### Step B: トーナメント開始（Go Live）

1. **開始操作**
   - [ ] SQL でステータス変更（手動）
   - [ ] 変更時刻記録（手動）

2. **即時確認**
   - [ ] LP 確認（手動）
   - [ ] Creator Dashboard 確認（手動）
   - [ ] Arena Page 確認（手動）

3. **初期異常チェック**
   - [ ] ランキング確認（手動）
   - [ ] 不正検知確認（手動）
   - [ ] ログ確認（手動）

#### Step C: 開催中運用（1日1回）

1. **毎日確認項目**
   - [ ] 注文件数確認（手動）
   - [ ] ランキング更新確認（手動）
   - [ ] 不正検知フラグ確認（手動）
   - [ ] Creator 問い合わせ確認（手動）

2. **手動対応**
   - [ ] 不正対応（手動）
   - [ ] バグ記録（手動）

#### Step D: 終了処理

1. **終了操作**
   - [ ] SQL でステータス変更（手動）
   - [ ] 終了時刻記録（手動）

2. **表示確認**
   - [ ] Creator Dashboard 確認（手動）
   - [ ] Arena Page 確認（手動）

#### Step E: 振り返り

1. **結果記録**
   - [ ] レポート作成（手動）

---

## 自動化対象の分類

### 自動化必須

**定義**: 手動では回らない / エラーが起きやすい

#### 1. トーナメントステータス自動遷移

**現状**: SQL で手動変更

**自動化内容**:
- `start_at` 時刻になったら自動で `scheduled` → `live` に変更
- `end_at` 時刻になったら自動で `live` → `finished` に変更

**技術的難易度**: 中
- Supabase Edge Functions または Vercel Cron Jobs を使用
- 定期的にトーナメントの `start_at` / `end_at` をチェック

**優先順位**: 高

**やらない理由**: [該当しない / 理由があれば記録]

---

#### 2. 日次監視レポート自動生成

**現状**: 毎日手動で確認

**自動化内容**:
- 注文件数、ランキング更新、不正検知フラグを自動で集計
- レポートを自動生成して Admin に通知（メール / Slack）

**技術的難易度**: 中
- Supabase Edge Functions または Vercel Cron Jobs を使用
- メール送信（SendGrid / Resend）または Slack Webhook

**優先順位**: 高

**やらない理由**: [該当しない / 理由があれば記録]

---

### 半自動でOK

**定義**: 手動でも回るが、自動化すると楽になる

#### 1. トーナメント作成UI

**現状**: SQL で手動作成

**自動化内容**:
- Admin 画面からトーナメントを作成できるUIを実装
- SQL を直接実行する必要がなくなる

**技術的難易度**: 低
- 既存の Admin 画面にフォームを追加
- `/api/admin/tournaments` の POST エンドポイントを使用

**優先順位**: 中

**やらない理由**: [該当しない / 理由があれば記録]

---

#### 2. Creator への自動通知

**現状**: メールを手動で送信

**自動化内容**:
- トーナメント開始時に Creator に自動でメール送信
- トーナメント終了時に Creator に自動でメール送信

**技術的難易度**: 低
- Supabase Edge Functions または Vercel Cron Jobs を使用
- メール送信（SendGrid / Resend）

**優先順位**: 中

**やらない理由**: [該当しない / 理由があれば記録]

---

#### 3. 異常検知アラート

**現状**: 手動でログを確認

**自動化内容**:
- API エラーが発生したら自動でアラート通知
- 不正検知フラグが発生したら自動でアラート通知

**技術的難易度**: 中
- Vercel Logs の監視（Sentry / Logtail）
- Supabase の Webhook または Edge Functions

**優先順位**: 中

**やらない理由**: [該当しない / 理由があれば記録]

---

### そもそも不要

**定義**: やらなくても問題ない

#### 1. 完全自動化されたトーナメント作成

**理由**: トーナメントの内容（期間、商品、参加者）は毎回異なるため、完全自動化は不要

---

#### 2. 自動報酬支払い

**理由**: 現時点では報酬支払いの仕組みが未実装のため、自動化の対象外

---

#### 3. 複数トーナメント同時開催

**理由**: 現時点では1つのトーナメントのみを運用する前提のため、不要

---

## 自動化実装の優先順位

### Phase 1（最優先）

1. **トーナメントステータス自動遷移**
   - 影響度: 高（手動ミスを防ぐ）
   - 工数: 中（1-2日）
   - 技術的難易度: 中

2. **日次監視レポート自動生成**
   - 影響度: 高（運用負担を軽減）
   - 工数: 中（1-2日）
   - 技術的難易度: 中

### Phase 2（次優先）

3. **トーナメント作成UI**
   - 影響度: 中（UX 改善）
   - 工数: 低（半日）
   - 技術的難易度: 低

4. **Creator への自動通知**
   - 影響度: 中（運用負担を軽減）
   - 工数: 低（半日）
   - 技術的難易度: 低

5. **異常検知アラート**
   - 影響度: 中（問題の早期発見）
   - 工数: 中（1-2日）
   - 技術的難易度: 中

---

## 技術的実装メモ

### Supabase Edge Functions

**用途**:
- トーナメントステータス自動遷移
- 日次監視レポート自動生成
- Creator への自動通知

**実装方法**:
- Supabase Dashboard → Edge Functions で作成
- `pg_cron` を使用して定期実行

### Vercel Cron Jobs

**用途**:
- トーナメントステータス自動遷移
- 日次監視レポート自動生成

**実装方法**:
- `vercel.json` に cron 設定を追加
- API Route を定期実行

### メール送信

**サービス候補**:
- SendGrid
- Resend
- Supabase Auth のメール機能

**実装方法**:
- Edge Functions または API Route からメール送信APIを呼び出し

---

## 非対応で許容する理由

### 自動化しない項目

1. **完全自動化されたトーナメント作成**
   - 理由: トーナメントの内容は毎回異なるため、手動での確認が必要

2. **自動報酬支払い**
   - 理由: 報酬支払いの仕組みが未実装のため、自動化の対象外

3. **複数トーナメント同時開催**
   - 理由: 現時点では1つのトーナメントのみを運用する前提

---

## Phase 14 への準備

### 自動化実装の開始条件

- [ ] 自動化対象の優先順位が決定されている
- [ ] 技術的実装方法が明確になっている
- [ ] 実装スケジュールが決定されている

### 次フェーズの作業内容

**Phase 14: Automation & Scale 実装**
- Phase 1 の自動化を実装
- Phase 2 の自動化を実装
- 手動運用前提を捨てる

---

## 関連ドキュメント

- [docs/PHASE12_DECISION.md](docs/PHASE12_DECISION.md): 判断ドキュメント
- [docs/PHASE11_LIVE_OPERATION.md](docs/PHASE11_LIVE_OPERATION.md): 本番運用実施手順書
- [docs/PHASE11_LIVE_REPORT.md](docs/PHASE11_LIVE_REPORT.md): 本番運用レポート

