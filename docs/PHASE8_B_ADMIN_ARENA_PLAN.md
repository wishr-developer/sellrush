# Phase 8-B: Admin / Tournament Ops Console å®Ÿè£…è¨ˆç”»

æœ€çµ‚æ›´æ–°: 2025-01-30

## ğŸ“‹ ç›®æ¬¡

1. [ç›®çš„](#ç›®çš„)
2. [ç¯„å›²](#ç¯„å›²)
3. [ç”»é¢æ§‹æˆ](#ç”»é¢æ§‹æˆ)
4. [API ä¸€è¦§ã¨ç°¡æ˜“ä»•æ§˜](#api-ä¸€è¦§ã¨ç°¡æ˜“ä»•æ§˜)
5. [èªè¨¼ãƒ»æ¨©é™](#èªè¨¼æ¨©é™)
6. [å®Ÿè£…ã‚¿ã‚¹ã‚¯](#å®Ÿè£…ã‚¿ã‚¹ã‚¯)

---

## ç›®çš„

ç®¡ç†è€…ãŒãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆï¼ˆArena / Tournamentï¼‰ã‚’ç®¡ç†ã§ãã‚‹ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’æä¾›ã™ã‚‹ã€‚

- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ä½œæˆãƒ»ç·¨é›†ãƒ»çŠ¶æ…‹ç®¡ç†
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ç¢ºèª
- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæƒ…å ±ã®ä¸€è¦§è¡¨ç¤º

---

## ç¯„å›²

### MVP ã§å®Ÿè£…ã™ã‚‹æ©Ÿèƒ½

1. **ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸€è¦§è¡¨ç¤º**
   - å…¨ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ä¸€è¦§
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆscheduled / live / finishedï¼‰
   - å„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®è©³ç´°ãƒ»ç·¨é›†ã¸ã®ãƒªãƒ³ã‚¯

2. **ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè©³ç´°ãƒ»ç·¨é›†**
   - åŸºæœ¬æƒ…å ±ã®è¡¨ç¤ºãƒ»ç·¨é›†ï¼ˆtitle, description, status, start_at, end_at, product_idï¼‰
   - ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆã€ä¸Šä½10ä»¶ï¼‰
   - çµ±è¨ˆæƒ…å ±ï¼ˆå‚åŠ è€…æ•°ã€ç·å£²ä¸Šï¼‰

3. **ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä½œæˆ**
   - æ–°è¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ä½œæˆï¼ˆPOST APIï¼‰

4. **èªè¨¼ãƒ»æ¨©é™ç®¡ç†**
   - Admin ãƒ­ãƒ¼ãƒ«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   - ãƒšãƒ¼ã‚¸å´ã¨ API å´ã®ä¸¡æ–¹ã§ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯

### å°†æ¥ã®æ‹¡å¼µï¼ˆMVPã§ã¯å®Ÿè£…ã—ãªã„ï¼‰

- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®å‰Šé™¤æ©Ÿèƒ½
- è¤‡é›‘ãªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
- ãƒãƒ«ãƒè³é‡‘è¨­è¨ˆ
- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®è¤‡è£½æ©Ÿèƒ½
- ä¸€æ‹¬æ“ä½œï¼ˆè¤‡æ•°ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®çŠ¶æ…‹å¤‰æ›´ãªã©ï¼‰

---

## ç”»é¢æ§‹æˆ

### 1. Admin Dashboard (`/admin`)

**ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³**:
- Ordersï¼ˆä¸»å°ç·šï¼‰
- Payouts, Fraud, Users, **Arena**ï¼ˆå‰¯å°ç·šï¼‰

**Arena ã¸ã®ãƒªãƒ³ã‚¯**: `/admin/arena/tournaments`

### 2. Tournament ä¸€è¦§ãƒšãƒ¼ã‚¸ (`/admin/arena/tournaments`)

**è¡¨ç¤ºé …ç›®**:
- ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆåï¼ˆtitleï¼‰
- Slug
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆscheduled / live / finishedï¼‰
- æœŸé–“ï¼ˆstart_at / end_atï¼‰
- å¯¾è±¡å•†å“IDï¼ˆproduct_idï¼‰

**æ©Ÿèƒ½**:
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿
- å„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ã€Œè©³ç´°ã€ãƒœã‚¿ãƒ³ï¼ˆ`/admin/arena/tournaments/[slug]` ã¸ï¼‰
- å„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®ã€Œç·¨é›†ã€ãƒœã‚¿ãƒ³ï¼ˆ`/admin/arena/tournaments/[slug]/edit` ã¸ï¼‰
- æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ï¼ˆ`/admin/arena/tournaments/new` ã¸ã€å°†æ¥å®Ÿè£…ï¼‰

### 3. Tournament è©³ç´°ãƒ»ç·¨é›†ãƒšãƒ¼ã‚¸ (`/admin/arena/tournaments/[slug]`)

**è¡¨ç¤ºé …ç›®**:
- åŸºæœ¬æƒ…å ±:
  - ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆtitleï¼‰
  - èª¬æ˜ï¼ˆdescriptionï¼‰
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆstatusï¼‰
  - é–‹å§‹æ™‚åˆ»ï¼ˆstart_atï¼‰
  - çµ‚äº†æ™‚åˆ»ï¼ˆend_atï¼‰
  - å¯¾è±¡å•†å“ï¼ˆproduct_id / product_nameï¼‰

**ç·¨é›†æ©Ÿèƒ½**:
- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
- ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚ˆã‚‹æƒ…å ±æ›´æ–°
- ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆPATCH API ã‚’å‘¼ã³å‡ºã—ï¼‰

**ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º**:
- Current Leaderboardï¼ˆä¸Šä½10ä»¶ï¼‰
- é †ä½ã€ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼IDã€æ³¨æ–‡ä»¶æ•°ã€å£²ä¸Šé‡‘é¡

**çµ±è¨ˆæƒ…å ±**:
- å‚åŠ è€…æ•°
- ç·å£²ä¸Š

---

## API ä¸€è¦§ã¨ç°¡æ˜“ä»•æ§˜

### 1. `GET /api/admin/tournaments`

**å½¹å‰²**: ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—ï¼ˆAdmin view ç”¨ï¼‰

**ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `status`ï¼ˆä»»æ„ï¼‰: `scheduled` | `live` | `finished`
- `product_id`ï¼ˆä»»æ„ï¼‰: ç‰¹å®šå•†å“ã®ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  tournaments: Tournament[]
}
```

**ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯**: `admin` ãƒ­ãƒ¼ãƒ«ã®ã¿

### 2. `POST /api/admin/tournaments`

**å½¹å‰²**: æ–°è¦ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆä½œæˆ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**:
```typescript
{
  title: string; // å¿…é ˆ
  slug: string; // å¿…é ˆã€ãƒ¦ãƒ‹ãƒ¼ã‚¯
  description?: string;
  status?: 'scheduled' | 'live' | 'finished'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'scheduled'
  startAt: string; // ISO 8601, å¿…é ˆ
  endAt: string; // ISO 8601, å¿…é ˆ
  productId?: string; // UUID
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  tournament: Tournament
}
```

**ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯**: `admin` ãƒ­ãƒ¼ãƒ«ã®ã¿

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**:
- `title` ã¨ `slug` ã¯å¿…é ˆ
- `startAt` ã¨ `endAt` ã¯å¿…é ˆ
- `endAt` ã¯ `startAt` ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
- `slug` ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯

### 3. `GET /api/admin/tournaments/[slug]`

**å½¹å‰²**: ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆè©³ç´°ã‚’å–å¾—

**ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `slug`: ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã® slug

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  tournament: TournamentWithProduct
}
```

**ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯**: `admin` ãƒ­ãƒ¼ãƒ«ã®ã¿

### 4. `PATCH /api/admin/tournaments/[slug]`

**å½¹å‰²**: ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆæ›´æ–°

**ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
- `slug`: ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã® slug

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£**ï¼ˆã™ã¹ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:
```typescript
{
  title?: string;
  description?: string | null;
  status?: 'scheduled' | 'live' | 'finished';
  startAt?: string; // ISO 8601
  endAt?: string; // ISO 8601
  productId?: string | null; // UUID
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```typescript
{
  tournament: TournamentWithProduct
}
```

**ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯**: `admin` ãƒ­ãƒ¼ãƒ«ã®ã¿

**ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**:
- `status` ã¯ 'scheduled', 'live', 'finished' ã®ã„ãšã‚Œã‹
- `startAt` ã¨ `endAt` ã®æ—¥ä»˜å½¢å¼ãƒã‚§ãƒƒã‚¯
- `endAt` ã¯ `startAt` ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹

---

## èªè¨¼ãƒ»æ¨©é™

### ãƒšãƒ¼ã‚¸å´ã®ã‚¬ãƒ¼ãƒ‰

- `src/app/admin/arena/...` ã®ãƒšãƒ¼ã‚¸ã§ã€`createServerSupabaseClient()` ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ `supabase.auth.getUser()` ã‚’ä½¿ç”¨
- `user.user_metadata?.role !== 'admin'` ã®å ´åˆã¯ `/login` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### API å´ã®ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯

- ã™ã¹ã¦ã® Admin Tournament API ã§ `admin` ãƒ­ãƒ¼ãƒ«ã®ã¿è¨±å¯
- æ¨©é™ä¸è¶³ã®å ´åˆã¯ `forbiddenError()` ã‚’è¿”ã™

### å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

æ—¢å­˜ã® Admin ãƒšãƒ¼ã‚¸ï¼ˆ`AdminOrdersClient`, `AdminPayoutsClient` ãªã©ï¼‰ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨:

```typescript
const {
  data: { user },
} = await supabase.auth.getUser();

if (!user || user.user_metadata?.role !== "admin") {
  router.replace("/login");
  return;
}
```

---

## å®Ÿè£…ã‚¿ã‚¹ã‚¯

### P8-B-1: Admin ç”¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ•´ç† âœ…

- [x] `src/app/admin/arena/layout.tsx` ã‚’ä½œæˆ
- [x] Admin Dashboard ã« Arena ã¸ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã‚’è¿½åŠ 

### P8-B-2: Tournament ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆAdmin ç”¨ï¼‰ âœ…

- [x] `src/app/admin/arena/tournaments/page.tsx` ã‚’ä½œæˆ
- [x] `AdminTournamentsClient.tsx` ã‚’ä½œæˆ
- [x] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿æ©Ÿèƒ½
- [x] å„ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã®è©³ç´°ãƒ»ç·¨é›†ã¸ã®ãƒªãƒ³ã‚¯

### P8-B-3: Tournament è©³ç´°ãƒ»ç·¨é›†ãƒšãƒ¼ã‚¸ âœ…

- [x] `src/app/admin/arena/tournaments/[slug]/page.tsx` ã‚’ä½œæˆ
- [x] `AdminTournamentDetailClient.tsx` ã‚’ä½œæˆ
- [x] åŸºæœ¬æƒ…å ±ã®è¡¨ç¤ºãƒ»ç·¨é›†æ©Ÿèƒ½
- [x] ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
- [x] çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º

### P8-B-4: Admin ç”¨ API Routes (CRUD / State ç®¡ç†) âœ…

- [x] `GET /api/admin/tournaments` ã‚’å®Ÿè£…
- [x] `POST /api/admin/tournaments` ã‚’å®Ÿè£…
- [x] `GET /api/admin/tournaments/[slug]` ã‚’å®Ÿè£…
- [x] `PATCH /api/admin/tournaments/[slug]` ã‚’å®Ÿè£…
- [x] ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆadmin ã®ã¿ï¼‰
- [x] çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### P8-B-5: Auth / ã‚¬ãƒ¼ãƒ‰å‡¦ç†ã¨ UX âœ…

- [x] ãƒšãƒ¼ã‚¸å´ã®ã‚¬ãƒ¼ãƒ‰ï¼ˆAdmin ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ï¼‰
- [x] API å´ã®ãƒ­ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
- [x] æ¨©é™ä¸è¶³æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†

### P8-B-6: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ & æœ€çµ‚ç¢ºèª âœ…

- [x] `docs/PHASE8_B_ADMIN_ARENA_PLAN.md` ã‚’ä½œæˆ
- [x] `docs/PHASE8_B_ADMIN_ARENA_SUMMARY.md` ã‚’ä½œæˆ
- [x] ãƒ“ãƒ«ãƒ‰ & å‹ãƒã‚§ãƒƒã‚¯ç¢ºèª

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docs/PHASE8_ARENA_PLAN.md`: Arena / Tournament MVP ã®å®Ÿè£…è¨ˆç”»
- `docs/PHASE8_ARENA_SUMMARY.md`: Arena / Tournament MVP ã®å®Ÿè£…ã¾ã¨ã‚
- `docs/PHASE6_AUTH_PLAN.md`: ãƒ­ãƒ¼ãƒ« & æ¨©é™ã®å®šç¾©

